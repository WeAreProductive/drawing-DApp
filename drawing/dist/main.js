(()=>{"use strict";let e=!1,r=!1;const t={debug:1,default:2,info:2,warning:3,error:4,off:5};let n=t.default,o=null;const s=function(){try{const e=[];if(["NFD","NFC","NFKD","NFKC"].forEach((r=>{try{if("test"!=="test".normalize(r))throw new Error("bad normalize")}catch(t){e.push(r)}})),e.length)throw new Error("missing "+e.join(", "));if(String.fromCharCode(233).normalize("NFD")!==String.fromCharCode(101,769))throw new Error("broken implementation")}catch(e){return e.message}return null}();var a,i;!function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARNING="WARNING",e.ERROR="ERROR",e.OFF="OFF"}(a||(a={})),function(e){e.UNKNOWN_ERROR="UNKNOWN_ERROR",e.NOT_IMPLEMENTED="NOT_IMPLEMENTED",e.UNSUPPORTED_OPERATION="UNSUPPORTED_OPERATION",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.TIMEOUT="TIMEOUT",e.BUFFER_OVERRUN="BUFFER_OVERRUN",e.NUMERIC_FAULT="NUMERIC_FAULT",e.MISSING_NEW="MISSING_NEW",e.INVALID_ARGUMENT="INVALID_ARGUMENT",e.MISSING_ARGUMENT="MISSING_ARGUMENT",e.UNEXPECTED_ARGUMENT="UNEXPECTED_ARGUMENT",e.CALL_EXCEPTION="CALL_EXCEPTION",e.INSUFFICIENT_FUNDS="INSUFFICIENT_FUNDS",e.NONCE_EXPIRED="NONCE_EXPIRED",e.REPLACEMENT_UNDERPRICED="REPLACEMENT_UNDERPRICED",e.UNPREDICTABLE_GAS_LIMIT="UNPREDICTABLE_GAS_LIMIT",e.TRANSACTION_REPLACED="TRANSACTION_REPLACED"}(i||(i={}));const c="0123456789abcdef";class l{constructor(e){Object.defineProperty(this,"version",{enumerable:!0,value:e,writable:!1})}_log(e,r){const o=e.toLowerCase();null==t[o]&&this.throwArgumentError("invalid log level name","logLevel",e),n>t[o]||console.log.apply(console,r)}debug(...e){this._log(l.levels.DEBUG,e)}info(...e){this._log(l.levels.INFO,e)}warn(...e){this._log(l.levels.WARNING,e)}makeError(e,t,n){if(r)return this.makeError("censored error",t,{});t||(t=l.errors.UNKNOWN_ERROR),n||(n={});const o=[];Object.keys(n).forEach((e=>{const r=n[e];try{if(r instanceof Uint8Array){let t="";for(let e=0;e<r.length;e++)t+=c[r[e]>>4],t+=c[15&r[e]];o.push(e+"=Uint8Array(0x"+t+")")}else o.push(e+"="+JSON.stringify(r))}catch(r){o.push(e+"="+JSON.stringify(n[e].toString()))}})),o.push(`code=${t}`),o.push(`version=${this.version}`);const s=e;let a="";switch(t){case i.NUMERIC_FAULT:{a="NUMERIC_FAULT";const r=e;switch(r){case"overflow":case"underflow":case"division-by-zero":a+="-"+r;break;case"negative-power":case"negative-width":a+="-unsupported";break;case"unbound-bitwise-result":a+="-unbound-result"}break}case i.CALL_EXCEPTION:case i.INSUFFICIENT_FUNDS:case i.MISSING_NEW:case i.NONCE_EXPIRED:case i.REPLACEMENT_UNDERPRICED:case i.TRANSACTION_REPLACED:case i.UNPREDICTABLE_GAS_LIMIT:a=t}a&&(e+=" [ See: https://links.ethers.org/v5-errors-"+a+" ]"),o.length&&(e+=" ("+o.join(", ")+")");const E=new Error(e);return E.reason=s,E.code=t,Object.keys(n).forEach((function(e){E[e]=n[e]})),E}throwError(e,r,t){throw this.makeError(e,r,t)}throwArgumentError(e,r,t){return this.throwError(e,l.errors.INVALID_ARGUMENT,{argument:r,value:t})}assert(e,r,t,n){e||this.throwError(r,t,n)}assertArgument(e,r,t,n){e||this.throwArgumentError(r,t,n)}checkNormalize(e){null==e&&(e="platform missing String.prototype.normalize"),s&&this.throwError("platform missing String.prototype.normalize",l.errors.UNSUPPORTED_OPERATION,{operation:"String.prototype.normalize",form:s})}checkSafeUint53(e,r){"number"==typeof e&&(null==r&&(r="value not safe"),(e<0||e>=9007199254740991)&&this.throwError(r,l.errors.NUMERIC_FAULT,{operation:"checkSafeInteger",fault:"out-of-safe-range",value:e}),e%1&&this.throwError(r,l.errors.NUMERIC_FAULT,{operation:"checkSafeInteger",fault:"non-integer",value:e}))}checkArgumentCount(e,r,t){t=t?": "+t:"",e<r&&this.throwError("missing argument"+t,l.errors.MISSING_ARGUMENT,{count:e,expectedCount:r}),e>r&&this.throwError("too many arguments"+t,l.errors.UNEXPECTED_ARGUMENT,{count:e,expectedCount:r})}checkNew(e,r){e!==Object&&null!=e||this.throwError("missing new",l.errors.MISSING_NEW,{name:r.name})}checkAbstract(e,r){e===r?this.throwError("cannot instantiate abstract class "+JSON.stringify(r.name)+" directly; use a sub-class",l.errors.UNSUPPORTED_OPERATION,{name:e.name,operation:"new"}):e!==Object&&null!=e||this.throwError("missing new",l.errors.MISSING_NEW,{name:r.name})}static globalLogger(){return o||(o=new l("logger/5.6.0")),o}static setCensorship(t,n){if(!t&&n&&this.globalLogger().throwError("cannot permanently disable censorship",l.errors.UNSUPPORTED_OPERATION,{operation:"setCensorship"}),e){if(!t)return;this.globalLogger().throwError("error censorship permanent",l.errors.UNSUPPORTED_OPERATION,{operation:"setCensorship"})}r=!!t,e=!!n}static setLogLevel(e){const r=t[e.toLowerCase()];null!=r?n=r:l.globalLogger().warn("invalid log level - "+e)}static from(e){return new l(e)}}l.errors=i,l.levels=a;const E=new l("bytes/5.6.1");function u(e){return e.slice||(e.slice=function(){const r=Array.prototype.slice.call(arguments);return u(new Uint8Array(Array.prototype.slice.apply(e,r)))}),e}function N(e){return"number"==typeof e&&e==e&&e%1==0}function g(e,r){if(r||(r={}),"number"==typeof e){E.checkSafeUint53(e,"invalid arrayify value");const r=[];for(;e;)r.unshift(255&e),e=parseInt(String(e/256));return 0===r.length&&r.push(0),u(new Uint8Array(r))}if(r.allowMissingPrefix&&"string"==typeof e&&"0x"!==e.substring(0,2)&&(e="0x"+e),function(e){return!!e.toHexString}(e)&&(e=e.toHexString()),function(e,r){return!("string"!=typeof e||!e.match(/^0x[0-9A-Fa-f]*$/)||r&&e.length!==2+2*r)}(e)){let t=e.substring(2);t.length%2&&("left"===r.hexPad?t="0"+t:"right"===r.hexPad?t+="0":E.throwArgumentError("hex data is odd-length","value",e));const n=[];for(let e=0;e<t.length;e+=2)n.push(parseInt(t.substring(e,e+2),16));return u(new Uint8Array(n))}return function(e){if(null==e)return!1;if(e.constructor===Uint8Array)return!0;if("string"==typeof e)return!1;if(!N(e.length)||e.length<0)return!1;for(let r=0;r<e.length;r++){const t=e[r];if(!N(t)||t<0||t>=256)return!1}return!0}(e)?u(new Uint8Array(e)):E.throwArgumentError("invalid arrayify value","value",e)}const h=new l("strings/5.6.1");var R,f;function p(e,r,t,n,o){if(e===f.BAD_PREFIX||e===f.UNEXPECTED_CONTINUE){let e=0;for(let n=r+1;n<t.length&&t[n]>>6==2;n++)e++;return e}return e===f.OVERRUN?t.length-r-1:0}!function(e){e.current="",e.NFC="NFC",e.NFD="NFD",e.NFKC="NFKC",e.NFKD="NFKD"}(R||(R={})),function(e){e.UNEXPECTED_CONTINUE="unexpected continuation byte",e.BAD_PREFIX="bad codepoint prefix",e.OVERRUN="string overrun",e.MISSING_CONTINUE="missing continuation byte",e.OUT_OF_RANGE="out of UTF-8 range",e.UTF16_SURROGATE="UTF-16 surrogate",e.OVERLONG="overlong representation"}(f||(f={}));const d=Object.freeze({error:function(e,r,t,n,o){return h.throwArgumentError(`invalid codepoint at offset ${r}; ${e}`,"bytes",t)},ignore:p,replace:function(e,r,t,n,o){return e===f.OVERLONG?(n.push(o),0):(n.push(65533),p(e,r,t))}});function O(e,r){return function(e,r){null==r&&(r=d.error),e=g(e);const t=[];let n=0;for(;n<e.length;){const o=e[n++];if(o>>7==0){t.push(o);continue}let s=null,a=null;if(192==(224&o))s=1,a=127;else if(224==(240&o))s=2,a=2047;else{if(240!=(248&o)){n+=r(128==(192&o)?f.UNEXPECTED_CONTINUE:f.BAD_PREFIX,n-1,e,t);continue}s=3,a=65535}if(n-1+s>=e.length){n+=r(f.OVERRUN,n-1,e,t);continue}let i=o&(1<<8-s-1)-1;for(let o=0;o<s;o++){let o=e[n];if(128!=(192&o)){n+=r(f.MISSING_CONTINUE,n,e,t),i=null;break}i=i<<6|63&o,n++}null!==i&&(i>1114111?n+=r(f.OUT_OF_RANGE,n-1-s,e,t,i):i>=55296&&i<=57343?n+=r(f.UTF16_SURROGATE,n-1-s,e,t,i):i<=a?n+=r(f.OVERLONG,n-1-s,e,t,i):t.push(i))}return t}(e,r).map((e=>e<=65535?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10&1023),56320+(1023&e))))).join("")}const I={dataSource:"DrawingDApp",database:"drawing",collection:"images"},T={"Content-Type":"application/json","api-key":"n3xCRxOgEhZsOcrBGYsepjSFP1DXec1qlvjsoSdW9nk7KdyxHlXyc7OUIC4rGKPA","Access-Control-Request-Headers":"*"},U=require("https"),_=process.env.ROLLUP_HTTP_SERVER_URL;console.log("HTTP rollup_server url is "+_);var A={advance_state:async function(e){console.log("Received advance request data "+JSON.stringify(e));const r=e.payload;try{const e=O(r);console.log(`Adding notice TEST"${e}"`);(async(e,r)=>{const t=JSON.stringify({...I,document:{name:e,content:r}}),n={hostname:"https://eu-central-1.aws.data.mongodb-api.com",path:"/app/data-jhpfj/endpoint/data/v1/action/insertOne",method:"POST",headers:T},o=U.request(n,(e=>{let r="";console.log("Status Code:",e.statusCode),e.on("data",(e=>{r+=e})),e.on("end",(()=>{console.log("Body: ",JSON.parse(r))}))})).on("error",(e=>{console.log("Error: ",e.message)}));o.write(t),o.end()})(`${Date.now()}-canvas`,JSON.parse(e))}catch(e){console.log(`Adding notice with binary value "${r}"`)}const t=await fetch(_+"/notice",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({payload:r})});return await t.json(),"accept"},inspect_state:async function(e){console.log("Received inspect request data "+JSON.stringify(e));const r=e.payload;try{const e=O(r);console.log(`Adding report "${e}"`)}catch(e){console.log(`Adding report with binary value "${r}"`)}const t=await fetch(_+"/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({payload:r})});return console.log("Received report status "+t.status),"accept"}},S={status:"accept"},C=null;(async()=>{for(;;){console.log("Sending finish");const r=await fetch(_+"/finish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"accept"})});if(console.log("Received finish status "+r.status),202==r.status)console.log("No pending rollup request, trying again");else{const t=await r.json(),n=t.data.metadata;if(n&&0==n.epoch_index&&0==n.input_index)C=n.msg_sender,console.log("Captured rollup address: "+C);else{var e=A[t.request_type];S.status=await e(t.data)}}}})()})();